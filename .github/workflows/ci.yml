name: Check PR

on:
 pull_request:
 push:
   branches:
     - main

jobs:
 run-ci:
   env:
     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   runs-on: windows-latest

   steps:
     - name: 🚚 Get latest code
       uses: actions/checkout@v4

     - name: 🛠️ Setup .NET
       uses: actions/setup-dotnet@v4
       with:
           dotnet-version: 8.x

     - name: ✏️ Set abstractions version from CHANGELOG.md
       shell: pwsh
       run: ./scripts/Set-VersionFromChangelog.ps1 -ChangelogPath DG.XrmPluginCore.Abstractions/CHANGELOG.md -CsprojPath DG.XrmPluginCore.Abstractions/DG.XrmPluginCore.Abstractions.csproj

     - name: ✏️ Set implementations version from CHANGELOG.md
       shell: pwsh
       run: ./scripts/Set-VersionFromChangelog.ps1 -ChangelogPath DG.XrmPluginCore/CHANGELOG.md -CsprojPath DG.XrmPluginCore/DG.XrmPluginCore.csproj

     - name: 📦 Install dependencies
       run: dotnet restore

     - name: 🔨 Build solution
       run: dotnet build --configuration Release --no-restore

     - name: ✅ Run tests
       run: dotnet test --configuration Release --no-build --verbosity normal

     - name: 📦 Pack
       run: dotnet pack --configuration Release --no-build --output ./nupkg

     - name: 📤 Upload artifacts
       uses: actions/upload-artifact@v4
       with:
         name: packages
         path: ./nupkg