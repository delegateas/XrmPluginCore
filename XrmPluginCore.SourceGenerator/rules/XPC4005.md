# XPC4005: Consider using modern image registration API

## Severity

Info (Suggestion)

## Description

This rule reports when `AddImage()` is used with a lambda invocation expression (e.g., `s => s.HandleUpdate()`). While this is valid code, the modern `WithPreImage()` and `WithPostImage()` APIs with `nameof()` provide better type-safety and compile-time validation.

## ❌ Example of code that triggers this suggestion

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        // XPC4005: Consider using modern image registration API
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            s => s.HandleUpdate())
            .AddImage(ImageType.PreImage, x => x.Name);
    }
}
```

## ✅ How to fix

Convert to the modern `WithPreImage()`/`WithPostImage()` API with `nameof()`:

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name);
    }
}
```

## Why this matters

1. **Type-safe wrapper generation**: Using `WithPreImage()`/`WithPostImage()` with `nameof()` enables the source generator to create strongly-typed `PreImage` and `PostImage` wrapper classes. These provide IntelliSense support and compile-time safety.

2. **Signature validation**: The modern API enables compile-time validation that your handler method signature matches the registered images (XPC4003/XPC4004).

3. **Cleaner API**: `WithPreImage()` and `WithPostImage()` are more readable and express intent more clearly than the generic `AddImage()` method.

## When to suppress

This is an informational suggestion. You may choose to keep using `AddImage()` if:
- You're maintaining legacy code and don't want to refactor
- You intentionally don't need the type-safe wrappers
- You're passing arguments to the handler method that would be lost in conversion

## See also

- [XPC4004: Image registration without method reference](XPC4004.md)
- [XPC3001: Prefer nameof over string literal](XPC3001.md)
