# XPC4003: Handler signature does not match registered images (types exist)

## Severity

Error

## Description

This rule reports when a handler method signature does not match the registered images **and** the generated `PreImage`/`PostImage` types already exist. This is the escalated version of [XPC4002](XPC4002.md) that becomes an error once the types have been generated.

When you register images with `WithPreImage()` or `WithPostImage()`, the source generator creates type-safe wrapper classes. Your handler method must accept these wrapper types as parameters in the correct order.

## ❌ Example of violation

```csharp
using MyNamespace.PluginRegistrations.AccountPlugin.AccountUpdatePostOperation;

public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name);
    }
}

public interface IAccountService
{
    // XPC4003: Missing PreImage parameter
    void HandleUpdate();
}
```

## ✅ How to fix

Update the handler method signature to match the registered images:

```csharp
using MyNamespace.PluginRegistrations.AccountPlugin.AccountUpdatePostOperation;

public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name);
    }
}

public interface IAccountService
{
    // Correct: PreImage parameter matches the registered image
    void HandleUpdate(PreImage preImage);
}
```

## Parameter Order

When both images are registered, they must appear in this order:
1. `PreImage` (first)
2. `PostImage` (second)

```csharp
// Both images registered
.WithPreImage(x => x.Name)
.WithPostImage(x => x.AccountNumber);

// Handler must accept them in order: PreImage first, PostImage second
void HandleUpdate(PreImage preImage, PostImage postImage);
```

## Why this is an Error

This rule is an error (not a warning) because:

1. **The generated types exist**: The source generator has already created the `PreImage`/`PostImage` wrapper classes
2. **Runtime failure**: Without the correct signature, the plugin execution will fail at runtime
3. **Fix is available**: You can add the correct using statement and update the method signature

## Relationship with XPC4002

- **XPC4002 (Warning)**: Reported when the generated types don't exist yet. This allows the initial build to succeed so the types can be generated.
- **XPC4003 (Error)**: Reported when the generated types exist but the signature is still wrong. This prevents runtime failures.

## See also

- [XPC4002: Handler signature does not match registered images (types don't exist)](XPC4002.md)
- [XPC3003: Image registration without method reference](XPC3003.md)
