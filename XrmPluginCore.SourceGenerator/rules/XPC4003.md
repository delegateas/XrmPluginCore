# XPC4003: Handler signature does not match registered images

## Severity

Error

## Description

This rule reports when a handler method's signature does not match the images registered with `WithPreImage()`, `WithPostImage()`, or `AddImage()`. The handler method must accept parameters in a specific order: `PreImage` first (if registered), then `PostImage` (if registered).

## ❌ Examples of violations

### ❌ Missing PreImage parameter

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        // XPC4003: Handler method 'HandleUpdate' does not have expected signature.
        // Expected parameters in order: PreImage
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name);
    }
}

public interface IAccountService
{
    void HandleUpdate();  // Missing PreImage parameter!
}
```

### ❌ Missing PostImage parameter

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        // XPC4003: Handler method 'HandleUpdate' does not have expected signature.
        // Expected parameters in order: PostImage
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPostImage(x => x.Name);
    }
}

public interface IAccountService
{
    void HandleUpdate();  // Missing PostImage parameter!
}
```

### ❌ Wrong parameter order

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        // XPC4003: Handler method 'HandleUpdate' does not have expected signature.
        // Expected parameters in order: PreImage, PostImage
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name)
            .WithPostImage(x => x.AccountNumber);
    }
}

public interface IAccountService
{
    void HandleUpdate(PostImage post, PreImage pre);  // Wrong order!
}
```

## ✅ How to fix

Update the handler method signature to match the registered images:

```csharp
public class AccountPlugin : Plugin
{
    public AccountPlugin()
    {
        RegisterStep<Account, IAccountService>(
            EventOperation.Update,
            ExecutionStage.PostOperation,
            nameof(IAccountService.HandleUpdate))
            .WithPreImage(x => x.Name)
            .WithPostImage(x => x.AccountNumber);
    }
}

public interface IAccountService
{
    // Correct order: PreImage first, then PostImage
    void HandleUpdate(PreImage preImage, PostImage postImage);
}
```

### Parameter order rules

| Registered Images | Expected Signature |
|-------------------|-------------------|
| PreImage only | `void Method(PreImage preImage)` |
| PostImage only | `void Method(PostImage postImage)` |
| Both images | `void Method(PreImage preImage, PostImage postImage)` |
| No images | `void Method()` |

## Why this matters

1. **Type-safe code generation**: The source generator creates strongly-typed `PreImage` and `PostImage` wrapper classes that are injected into your handler method. If the signature doesn't match, the generated code won't compile or work correctly.

2. **Compile-time enforcement**: This error prevents developers from accidentally ignoring registered images, which could lead to subtle bugs where image data is never used.

3. **Clear contract**: The handler signature explicitly declares what data the method expects, making the code more readable and maintainable.

## Code fix available

Visual Studio and other IDEs supporting Roslyn analyzers will offer a code fix to update the method signature to match the registered images.

## See also

- [XPC4002: Handler method not found](XPC4002.md)
- [XPC4004: Image registration without method reference](XPC4004.md)
